<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PriChat</title>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.40.0/dist/umd/supabase.min.js"></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
  /* Reset & Global */
  * {margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
  body, html {width:100%;height:100%;overflow:hidden;background:#121212;color:white;}
  button,input {font-family:inherit;}
  
  /* Login / Signup UI */
  #auth-container {display:flex;justify-content:center;align-items:center;height:100vh;background:#1e1e1e;}
  #auth-box {background:#2a2a2a;padding:40px;border-radius:12px;width:350px;box-shadow:0 4px 20px rgba(0,0,0,0.5);}
  #auth-box h1 {text-align:center;margin-bottom:20px;color:#fff;}
  #auth-box input {width:100%;padding:10px;margin:8px 0;border-radius:6px;border:none;background:#3a3a3a;color:white;}
  #auth-box button {width:100%;padding:12px;margin-top:12px;border:none;border-radius:6px;background:#ff3b30;color:white;font-weight:bold;cursor:pointer;transition:0.2s;}
  #auth-box button:hover {background:#ff574f;}
  #auth-switch {text-align:center;margin-top:10px;color:#aaa;cursor:pointer;}
  #auth-switch:hover {color:white;}
</style>
</head>
<body>

<div id="auth-container">
  <div id="auth-box">
    <h1>PriChat</h1>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="login-btn">Login</button>
    <button id="signup-btn">Sign Up</button>
    <div id="auth-switch">Don't have an account? Sign Up</div>
  </div>
</div>

<script>
  // ---------------- Supabase Configuration ----------------
  const SUPABASE_URL = "https://qndloqakppscohtqjghs.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuZGxvcWFrcHBzY29odHFqZ2hzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDgwNTQsImV4cCI6MjA4MzcyNDA1NH0.2L5nJXixDIYYTpxB0rP2tOQI0A50S23rkphhCHMC6GE";

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ---------------- UI Elements ----------------
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginBtn = document.getElementById('login-btn');
  const signupBtn = document.getElementById('signup-btn');
  const authSwitch = document.getElementById('auth-switch');

  let isLoginMode = true;

  authSwitch.addEventListener('click', () => {
    isLoginMode = !isLoginMode;
    if(isLoginMode){
      loginBtn.style.display = "block";
      signupBtn.textContent = "Sign Up";
      authSwitch.textContent = "Don't have an account? Sign Up";
    } else {
      loginBtn.style.display = "none";
      signupBtn.textContent = "Create Account";
      authSwitch.textContent = "Already have an account? Login";
    }
  });

  // ---------------- Auth Functions ----------------
  signupBtn.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if(!email || !password){ alert('Enter email & password'); return; }
    try{
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
           {
            username: 'New User',
            country: '',
            avatar: ''
          }
        }
      });
      if(error) throw error;
      // Insert into users table
      const { error: dbError } = await supabase.from('users').insert({
        id: data.user.id,
        email: email,
        username: 'New User',
        country: '',
        avatar: ''
      });
      if(dbError) console.warn("User profile insert warning:", dbError);
      alert('Sign Up Successful! Check email if required, then login.');
    } catch(err){ 
      alert(err.message || err.error_description || 'Sign up failed'); 
    }
  });

  loginBtn.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if(!email || !password){ alert('Enter email & password'); return; }
    try{
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) throw error;
      // Redirect handled by auth state change
    } catch(err){ 
      alert(err.message || 'Login failed'); 
    }
  });

  // Hide login on auth success
  let currentUser = null;
  const authListener = supabase.auth.onAuthStateChange(async (event, session) => {
    if(event === 'SIGNED_IN' && session?.user){
      currentUser = session.user;
      loadApp();
    } else if(event === 'SIGNED_OUT'){
      currentUser = null;
      showAuth();
    }
  });

  function showAuth(){
    document.getElementById('auth-container').style.display = 'flex';
    document.body.style.display = 'block';
  }

  function loadApp(){
    document.getElementById('auth-container').style.display = 'none';
    document.body.style.display = 'flex';
    initMainApp();
  }

  // Initial check
  (async () => {
    const {  { session } } = await supabase.auth.getSession();
    if(session?.user){
      currentUser = session.user;
      loadApp();
    } else {
      showAuth();
    }
  })();
</script>

<!-- ---------------- Main PriChat UI ---------------- -->
<style>
  body {display:flex;flex-direction:row;height:100vh;overflow:hidden;}
  #auth-container{display:none;}

  /* Left Sidebar */
  #sidebar-left {width:250px;background:#202225;display:flex;flex-direction:column;}
  #sidebar-left h2 {color:#fff;text-align:center;padding:15px 0;border-bottom:1px solid #333;}
  #friends-list {flex:1;overflow-y:auto;}
  .friend-item {padding:12px 15px;color:#ddd;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
  .friend-item:hover {background:#2f3136;border-radius:6px;}
  .online-indicator {width:10px;height:10px;border-radius:50%;background:#43b581;margin-right:8px;}

  /* Middle Chat Panel */
  #chat-panel {flex:1;display:flex;flex-direction:column;background:#36393f;}
  #chat-header {padding:15px;border-bottom:1px solid #2f3136;color:white;font-weight:bold;}
  #messages-container {flex:1;overflow-y:auto;padding:15px;}
  .message {margin-bottom:10px;display:flex;align-items:flex-start;}
  .message.self {justify-content:flex-end;}
  .message-content {background:#7289da;color:white;padding:10px;border-radius:8px;max-width:70%;word-wrap:break-word;}
  .message-content.self {background:#5865f2;}
  #chat-input-container {display:flex;padding:10px;border-top:1px solid #2f3136;}
  #chat-input {flex:1;padding:10px;border-radius:6px;border:none;}
  #send-btn {padding:10px 15px;margin-left:10px;border:none;border-radius:6px;background:#43b581;color:white;cursor:pointer;transition:0.2s;}
  #send-btn:hover {background:#4cbf6f;}

  /* Right Sidebar */
  #sidebar-right {width:250px;background:#2f3136;display:flex;flex-direction:column;padding:15px;}
  #profile-section img {width:80px;height:80px;border-radius:50%;margin-bottom:10px;}
  #profile-section h3 {color:white;margin-bottom:5px;}
  #profile-section p {color:#aaa;margin-bottom:5px;}
  #profile-section button {padding:8px 12px;border:none;border-radius:6px;background:#5865f2;color:white;cursor:pointer;margin-top:5px;}
  #profile-section button:hover {background:#7289da;}
</style>

<div id="sidebar-left">
  <h2>Friends</h2>
  <div id="friends-list"></div>
</div>

<div id="chat-panel">
  <div id="chat-header">Select a friend to start chatting</div>
  <div id="messages-container"></div>
  <div id="chat-input-container">
    <input type="text" id="chat-input" placeholder="Type a message..." disabled>
    <button id="send-btn" disabled>Send</button>
  </div>
</div>

<div id="sidebar-right">
  <div id="profile-section">
    <img id="profile-avatar" src="" alt="Avatar">
    <h3 id="profile-username">Username</h3>
    <p id="profile-email"></p>
    <p id="profile-country"></p>
    <p>UID: <span id="profile-uid"></span></p>
    <button id="update-profile-btn">Update Profile</button>
    <button id="logout-btn">Logout</button>
  </div>
</div>

<script>
  let activeChatUid = null;
  let messagesChannel = null;

  async function initMainApp(){
    await loadUserProfile();
    await loadFriends();
    
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await supabase.auth.signOut();
    });

    document.getElementById('update-profile-btn').addEventListener('click', async () => {
      const newUsername = prompt('Enter new username:', document.getElementById('profile-username').textContent);
      if(newUsername){
        const { error } = await supabase
          .from('users')
          .update({ username: newUsername })
          .eq('id', currentUser.id);
        if(error){ alert('Update failed: ' + error.message); return; }
        document.getElementById('profile-username').textContent = newUsername;
        alert('Username updated!');
      }
    });

    document.getElementById('send-btn').addEventListener('click', sendMessage);
  }

  async function loadUserProfile(){
    const { data, error } = await supabase
      .from('users')
      .select('email, username, country, avatar')
      .eq('id', currentUser.id)
      .single();
    
    if(error){
      console.error("Profile load error:", error);
      return;
    }

    document.getElementById('profile-avatar').src = data.avatar || 'https://i.imgur.com/1Q9Z1ZQ.png';
    document.getElementById('profile-username').textContent = data.username;
    document.getElementById('profile-email').textContent = data.email;
    document.getElementById('profile-country').textContent = data.country || 'Country not set';
    document.getElementById('profile-uid').textContent = currentUser.id;
  }

  async function loadFriends(){
    const { data, error } = await supabase
      .from('users')
      .select('friends')
      .eq('id', currentUser.id)
      .single();

    if(error || !data?.friends?.length){
      document.getElementById('friends-list').innerHTML = '<div style="padding:15px;color:#777;">No friends yet</div>';
      return;
    }

    const friendsList = document.getElementById('friends-list');
    friendsList.innerHTML = '';

    for(const friendUid of data.friends){
      const {  friendData } = await supabase
        .from('users')
        .select('username')
        .eq('id', friendUid)
        .single();
      
      if(friendData){
        const friendItem = document.createElement('div');
        friendItem.classList.add('friend-item');
        friendItem.innerHTML = `<span><div class="online-indicator"></div>${friendData.username}</span><button onclick="startChat('${friendUid}','${friendData.username}')">Chat</button>`;
        friendsList.appendChild(friendItem);
      }
    }
  }

  function getChatId(uid1, uid2){
    return [uid1, uid2].sort().join('_');
  }

  function startChat(uid, username){
    activeChatUid = uid;
    document.getElementById('chat-header').textContent = 'Chat with ' + username;
    document.getElementById('chat-input').disabled = false;
    document.getElementById('send-btn').disabled = false;
    loadMessages(uid);
  }

  async function loadMessages(friendUid){
    const container = document.getElementById('messages-container');
    container.innerHTML = 'Loading...';

    // Clean up previous subscription
    if(messagesChannel) {
      await supabase.removeChannel(messagesChannel);
      messagesChannel = null;
    }

    const chatId = getChatId(currentUser.id, friendUid);

    // Initial load
    const { data, error } = await supabase
      .from('messages')
      .select('*')
      .eq('chat_id', chatId)
      .order('created_at', { ascending: true });

    if(error) {
      container.innerHTML = 'Failed to load messages.';
      return;
    }

    renderMessages(data, container);

    // Realtime subscription
    messagesChannel = supabase
      .channel(`chat-${chatId}`)
      .on(
        'postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` },
        (payload) => {
          const msg = payload.new;
          appendMessage(msg, container);
        }
      )
      .subscribe();
  }

  function renderMessages(messages, container){
    container.innerHTML = '';
    messages.forEach(msg => appendMessage(msg, container));
    container.scrollTop = container.scrollHeight;
  }

  function appendMessage(msg, container){
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message');
    if(msg.sender === currentUser.id) msgDiv.classList.add('self');
    msgDiv.innerHTML = `<div class="message-content">${this.escapeHtml(msg.text)}</div>`;
    container.appendChild(msgDiv);
    container.scrollTop = container.scrollHeight;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function sendMessage(){
    const text = document.getElementById('chat-input').value.trim();
    if(!text || !activeChatUid) return;

    const chatId = getChatId(currentUser.id, activeChatUid);
    const { error } = await supabase
      .from('messages')
      .insert({
        chat_id: chatId,
        sender: currentUser.id,
        text: text
      });

    if(error) alert('Send failed: ' + error.message);
    else document.getElementById('chat-input').value = '';
  }

  // Expose to global scope for inline onclick
  window.startChat = startChat;
</script>

</body>
</html>